<div class="add-client-container">
  <div class="add-client-box">
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Creating client...</div>
    </div>

    <div class="tabs">
      <button class="tab" [class.active]="activeTab === 'client-profile'" (click)="switchTab('client-profile')">
        Client Profile
      </button>
      <button class="tab" [class.active]="activeTab === 'primary-contacts'" (click)="switchTab('primary-contacts')">
        Primary Contacts
      </button>
    </div>

    <form #clientForm="ngForm" (ngSubmit)="onSubmit(clientForm)" class="client-form">
      <!-- CLIENT PROFILE TAB -->
      <div class="tab-content" *ngIf="activeTab === 'client-profile'">
        <div class="form-row">
          <div class="form-group">
            <label>Legal Entity Name*</label>
            <input type="text" name="legalEntityName" required [(ngModel)]="clientData.legalEntityName"
              #legalEntityName="ngModel" pattern="^[a-zA-Z\s]*$" placeholder="Legal Entity Name" />
            <div class="error" *ngIf="legalEntityName.invalid && (legalEntityName.touched || showErrors)">
              <small *ngIf="legalEntityName.errors?.['required']">Please enter Legal Entity Name.</small>
              <small *ngIf="legalEntityName.errors?.['pattern']">Numbers and special characters are not allowed.</small>
            </div>
          </div>
          <div class="form-group">
            <label>Trading / Brand Name</label>
            <input type="text" name="brandName" [(ngModel)]="clientData.brandName" placeholder="Trading / Brand Name" />
          </div>
        </div>

        <div class="form-row">
          <!-- Country Field -->
          <div class="form-group custom-dropdown country-dropdown">
            <label>Country*</label>
            <div class="dropdown-container">
              <input type="text" name="country" required [(ngModel)]="clientData.country"
                (click)="openCountryDropdown($event)" #country="ngModel" placeholder="Select country..." readonly
                class="dropdown-input" />
              <div class="dropdown-icon">▼</div>

              <div class="dropdown-list" *ngIf="showCountryDropdown" (mouseleave)="closeCountryDropdown()">
                <div class="search-container" (click)="$event.stopPropagation()">
                  <input type="text" name="countrySearch" placeholder="Search country..." [(ngModel)]="countrySearch"
                    (ngModelChange)="filterCountries()" class="search-input" autocomplete="off" />
                </div>
                <div class="dropdown-items">
                  <div *ngFor="let country of filteredCountries" class="dropdown-item" (click)="selectCountry(country)">
                    {{ country.country }}
                  </div>
                  <div *ngIf="filteredCountries.length === 0" class="no-results">
                    No countries found
                  </div>
                </div>
              </div>
            </div>
            <div class="error" *ngIf="country.invalid && (country.touched || showErrors)">
              <small>Please select a country.</small>
            </div>
          </div>

          <!-- State Field -->
          <div class="form-group custom-dropdown state-dropdown">
            <label>State*</label>
            <div class="dropdown-container">
              <input type="text" name="state" required [(ngModel)]="clientData.state"
                (click)="openStateDropdown($event)" #state="ngModel"
                placeholder="{{ clientData.country ? 'Select state...' : 'Select country first' }}" readonly
                class="dropdown-input" [disabled]="!clientData.country" />
              <div class="dropdown-icon">▼</div>

              <div class="dropdown-list" *ngIf="showStateDropdown && clientData.country"
                (mouseleave)="closeStateDropdown()">
                <div class="search-container" (click)="$event.stopPropagation()">
                  <input type="text" name="stateSearch" placeholder="Search state..." [(ngModel)]="stateSearch"
                    (ngModelChange)="filterStates()" class="search-input" autocomplete="off" />
                </div>
                <div class="dropdown-items">
                  <div *ngFor="let state of filteredStates" class="dropdown-item" (click)="selectState(state)">
                    {{ state.name }}
                  </div>
                  <div *ngIf="filteredStates.length === 0 && allStates.length > 0" class="no-results">
                    No states found
                  </div>
                  <div *ngIf="allStates.length === 0" class="no-results">
                    Loading states...
                  </div>
                </div>
              </div>
            </div>
            <div class="error" *ngIf="state.invalid && (state.touched || showErrors)">
              <small>Please select a state.</small>
            </div>
            <div *ngIf="!clientData.country" class="field-hint">
              Please select a country first
            </div>
          </div>

          <!-- City Field -->
          <div class="form-group custom-dropdown city-dropdown">
            <label>City*</label>
            <div class="dropdown-container">
              <input type="text" name="city" required [(ngModel)]="clientData.city" (click)="openCityDropdown($event)"
                #city="ngModel" placeholder="{{ clientData.state ? 'Select city...' : 'Select state first' }}" readonly
                class="dropdown-input" [disabled]="!clientData.state" />
              <div class="dropdown-icon">▼</div>

              <div class="dropdown-list" *ngIf="showCityDropdown && clientData.state"
                (mouseleave)="closeCityDropdown()">
                <div class="search-container" (click)="$event.stopPropagation()">
                  <input type="text" name="citySearch" placeholder="Search city..." [(ngModel)]="citySearch"
                    (ngModelChange)="filterCities()" class="search-input" autocomplete="off" />
                </div>
                <div class="dropdown-items">
                  <div *ngFor="let city of filteredCities" class="dropdown-item" (click)="selectCity(city)">
                    {{ city }}
                  </div>
                  <div *ngIf="filteredCities.length === 0 && allCities.length > 0" class="no-results">
                    No cities found
                  </div>
                  <div *ngIf="allCities.length === 0" class="no-results">
                    Loading cities...
                  </div>
                </div>
              </div>
            </div>
            <div class="error" *ngIf="city.invalid && (city.touched || showErrors)">
              <small>Please select a city.</small>
            </div>
            <div *ngIf="!clientData.state" class="field-hint">
              Please select a state first
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Street*</label>
            <input type="text" name="street" required [(ngModel)]="clientData.street" #street="ngModel"
              placeholder="Street" />
            <div class="error" *ngIf="street.invalid && (street.touched || showErrors)">
              <small>Please enter Street.</small>
            </div>
          </div>
          <div class="form-group">
            <label>Zip Code*</label>
            <input type="text" name="zipCode" required [(ngModel)]="clientData.zipCode" #zipCode="ngModel"
              pattern="^[0-9]*$" placeholder="Zip Code" />
            <div class="error" *ngIf="zipCode.invalid && (zipCode.touched || showErrors)">
              <small *ngIf="zipCode.errors?.['required']">Please enter Zip Code.</small>
              <small *ngIf="zipCode.errors?.['pattern']">Zip Code must be numeric.</small>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nature of Business</label>
            <input type="text" name="natureOfBusiness" [(ngModel)]="clientData.natureOfBusiness"
              placeholder="Nature of Business" />
          </div>
          <div class="form-group">
            <label>Website / Domain URL</label>
            <input type="url" name="website" [(ngModel)]="clientData.website" #website="ngModel"
              pattern="^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$"
              placeholder="https://example.com" />
            <div class="error" *ngIf="website.invalid && website.touched">
              <small>Please enter a valid URL.</small>
            </div>
          </div>
          <div class="form-group">
            <label>Type of Business*</label>
            <input type="text" name="typeOfBusiness" required [(ngModel)]="clientData.typeOfBusiness"
              #typeOfBusiness="ngModel" placeholder="Type of Business" />
            <div class="error" *ngIf="typeOfBusiness.invalid && (typeOfBusiness.touched || showErrors)">
              <small>Please enter Type of Business.</small>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-primary" (click)="saveAndContinue(clientForm)" [disabled]="isLoading">
            <img src="/assets/icons/arrow_circle_down.png" alt="arrow_down" />
            <span>Save and Continue</span>
          </button>
        </div>
      </div>

      <!-- PRIMARY CONTACTS TAB -->
      <div class="tab-content" *ngIf="activeTab === 'primary-contacts'">
        <div class="form-row">
          <div class="form-group">
            <label>Name*</label>
            <input type="text" name="primaryName" required [(ngModel)]="clientData.primaryName" #primaryName="ngModel"
              pattern="^[a-zA-Z\s]*$" placeholder="Enter Name" />
            <div class="error" *ngIf="primaryName.invalid && (primaryName.touched || showErrors)">
              <small *ngIf="primaryName.errors?.['required']">Please enter Name.</small>
              <small *ngIf="primaryName.errors?.['pattern']">Name cannot contain numbers or special characters.</small>
            </div>
          </div>
          <div class="form-group">
            <label>Designation*</label>
            <input type="text" name="primaryDesignation" required [(ngModel)]="clientData.primaryDesignation"
              #primaryDesignation="ngModel" placeholder="Enter Designation" />
            <div class="error" *ngIf="primaryDesignation.invalid && (primaryDesignation.touched || showErrors)">
              <small>Please enter Designation.</small>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Email*</label>
            <input type="email" name="primaryEmail" required [(ngModel)]="clientData.primaryEmail"
              #primaryEmail="ngModel" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" placeholder="Enter Email" />
            <div class="error" *ngIf="primaryEmail.invalid && (primaryEmail.touched || showErrors)">
              <small *ngIf="primaryEmail.errors?.['required']">Please enter Email.</small>
              <small *ngIf="primaryEmail.errors?.['pattern']">Please enter a valid email address.</small>
            </div>
          </div>
          <div class="form-group">
            <label>Phone*</label>
            <div class="phone-input-container">
              <div class="country-code-dropdown custom-dropdown">
                <div class="country-code-selector" (click)="openCountryCodeDropdown($event)">
                  <span class="country-code-flag">{{ getSelectedCountryCodeFlag() }}</span>
                  <span class="country-code-value">{{ clientData.phoneCountryCode }}</span>
                  <span class="dropdown-icon">▼</span>
                </div>

                <div class="dropdown-list country-code-list" *ngIf="showCountryCodeDropdown">
                  <div class="search-container" (click)="$event.stopPropagation()">
                    <input type="text" placeholder="Search country or code..." [(ngModel)]="countryCodeSearch"
                      (ngModelChange)="filterCountryCodes()" class="search-input" (click)="$event.stopPropagation()"
                      autocomplete="off" name="countryCodeSearch" />
                  </div>
                  <div class="dropdown-items">
                    <div *ngFor="let countryCode of filteredCountryCodes" class="dropdown-item country-code-item"
                      (click)="selectCountryCode(countryCode)">
                      <span class="country-code-flag">{{ countryCode.flag }}</span>
                      <span class="country-code-name">{{ countryCode.name }}</span>
                      <span class="country-code-value">{{ countryCode.code }}</span>
                    </div>
                    <div *ngIf="filteredCountryCodes.length === 0" class="no-results">
                      No country codes found
                    </div>
                  </div>
                </div>
              </div>

              <input type="tel" name="primaryPhone" required [(ngModel)]="clientData.primaryPhone"
                #primaryPhone="ngModel" [pattern]="getPhonePattern()" placeholder="Enter phone number"
                class="phone-number-input" />
            </div>

            <div class="error" *ngIf="primaryPhone.invalid && (primaryPhone.touched || showErrors)">
              <small *ngIf="primaryPhone.errors?.['required']">Phone number is required.</small>
              <small *ngIf="primaryPhone.errors?.['pattern']">
                {{ clientData.phoneCountryCode === '+91' ? 'India numbers must be exactly 10 digits.' : 'Invalid phone
                number format for ' + clientData.phoneCountryCode }}
              </small>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Technical Contacts</label>
            <input type="text" name="technicalContact" [(ngModel)]="clientData.technicalContact"
              placeholder="Enter Technical Contacts" />
          </div>
          <div class="form-group">
            <label>Information Security Officer</label>
            <input type="text" name="informationSecurityOfficer" [(ngModel)]="clientData.informationSecurityOfficer"
              placeholder="Enter ISO" />
          </div>
          <div class="form-group">
            <label>Client Status</label>
            <select name="clientStatus" [(ngModel)]="clientData.clientStatus">
              <option value="" disabled selected>Select Status</option>
              <option value="ACTIVE">Active</option>
              <option value="SUSPENDED">Suspended</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group wide">
            <label>Client Signoff Authority*</label>
            <input type="text" name="clientSignoff" required [(ngModel)]="clientData.clientSignoff"
              #clientSignoff="ngModel" placeholder="Enter Client Signoff Authority" />
            <div class="error" *ngIf="clientSignoff.invalid && (clientSignoff.touched || showErrors)">
              <small>Please enter Client Signoff Authority.</small>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="go-back-btn" (click)="goBack()" [disabled]="isLoading">
            <img src="/assets/icons/arrow_left_alt.png" alt="add_icon" />
          </button>
          <button type="button" class="btn-reset" (click)="resetPage(clientForm)" [disabled]="isLoading">
            <span>Reset Form</span>
          </button>
          <button type="button" class="btn-primary" (click)="submitClient(clientForm)" [disabled]="isLoading">
            <img src="/assets/icons/arrow_circle_down.png" alt="arrow_down" />
            <span>Submit Client</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>