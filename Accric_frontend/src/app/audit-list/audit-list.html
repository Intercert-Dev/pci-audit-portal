<div class="audit-list-container">
  <div class="audit-list-box">
    <div class="header-row">
      <p>Audit List</p>
      <div class="header-right">
        <div class="search-box">
          <img src="/assets/icons/magnifying-glass 2.png" alt="Search Icon">
          <input type="text" placeholder="Search Audits" [(ngModel)]="search_text" (input)="filter_list()">
        </div>
        <button class="export-btn" (click)="exportToExcel()"><span>Export to Excel</span></button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading audit data...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-container">
      <p>{{ errorMessage }}</p>
      <button (click)="fetchAuditList()">Retry</button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !errorMessage && filtered_list.length === 0" class="empty-state">
      <p>No audits found</p>
    </div>

    <!-- Audit Table -->
    <div class="table-wrapper" *ngIf="!isLoading && !errorMessage && filtered_list.length > 0">
      <table>
        <thead>
          <tr>
            <th>Company Name</th>
            <th>Assessment / Project Name</th>
            <th>Audit Status</th>
            <th>Audit Start Date</th>
            <th>Audit End Date</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let audit of filtered_list">
            <!-- Access nested client data -->
            <td>{{ audit.client.legal_entity_name || audit.client.trading_name || 'N/A' }}</td>
            <td>{{ audit.assessment_project_name || 'N/A' }}</td>
            <td>
              {{audit.audit_status}}
            </td>
            <td>{{ formatDate(audit.audit_start_date) || 'N/A' }}</td>
            <td>{{ formatDate(audit.audit_end_date) || 'N/A' }}</td>
            <td class="sticky-action">
              <div class="action-box">
                <img src="/assets/icons/edit.png" alt="Edit" (click)="editAudit(audit)" title="Edit Audit">
                <!-- <img src="/assets/icons/delete.png" alt="Delete" (click)="deleteAudit(audit)" title="Delete Audit"> -->
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Audit Popup -->
<div class="edit-audit-popup-overlay" *ngIf="editingAudit">
  <div class="edit-audit-popup">
    <div class="popup-header">
      <h2>Edit Audit - {{ editingAudit.assessment_project_name || 'Audit' }}</h2>
      <button class="close-btn" (click)="cancelEdit()">&times;</button>
    </div>

    <div class="popup-content">
      <form #editAuditForm="ngForm">

        <!-- Assessment Summary Section -->
        <div class="popup-section">
          <h3 class="section-title">Assessment Summary</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" readonly
                [value]="editingAudit.client.legal_entity_name || editingAudit.client.trading_name || 'N/A'" />
            </div>

            <div class="form-group">
              <label>Assessment / Project Name*</label>
              <input type="text" name="assessment_project_name" required
                [(ngModel)]="editingAudit.assessment_project_name" placeholder="Assessment / Project Name" />
            </div>

            <div class="form-group">
              <label>Assessment Type</label>
              <input type="text" name="assessment_type" [(ngModel)]="editingAudit.assessment_type"
                placeholder="Assessment Type" />
            </div>

            <div class="form-group">
              <label>Assessment Category</label>
              <input type="text" name="assessment_category" [(ngModel)]="editingAudit.assessment_category"
                placeholder="Assessment Category" />
            </div>

            <div class="form-group">
              <label>Assessment Year</label>
              <input type="text" name="assessment_year" [(ngModel)]="editingAudit.assessment_year"
                placeholder="Assessment Year" />
            </div>

            <div class="form-group">
              <label>PCI DSS Version Applicable</label>
              <input type="text" name="pci_dss_version_application"
                [(ngModel)]="editingAudit.pci_dss_version_application" placeholder="PCI DSS Version Applicable" />
            </div>

            <div class="form-group">
              <label>Assessment Period Covered</label>
              <input type="text" name="assessment_period_covered" [(ngModel)]="editingAudit.assessment_period_covered"
                placeholder="Assessment Period Covered" />
            </div>

            <div class="form-group">
              <label>Audit Start Date*</label>
              <input type="date" name="audit_start_date" required [(ngModel)]="editingAudit.audit_start_date" />
            </div>

            <div class="form-group">
              <label>Audit End Date*</label>
              <input type="date" name="audit_end_date" required [(ngModel)]="editingAudit.audit_end_date" />
            </div>

            <div class="form-group">
              <label>Date of Report Submission</label>
              <input type="date" name="date_of_report_submission"
                [(ngModel)]="editingAudit.date_of_report_submission" />
            </div>

            <div class="form-group">
              <label>Audit Status</label>
              <select name="audit_status" [(ngModel)]="editingAudit.audit_status">
                <option value="" disabled>Select Status</option>
                <option value="REPORT_IN_REVIEW">Report In Review</option>
                <option value="COMPLETED">Completed</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="NOT_STARTED">Not Started</option>
              </select>
            </div>

            <div class="form-group">
              <label>Certificate Issue Date</label>
              <input type="date" name="certificate_issue_date" [(ngModel)]="editingAudit.certificate_issue_date" />
            </div>

            <div class="form-group">
              <label>Certificate Expiry Date</label>
              <input type="date" name="certificate_expiry_date" [(ngModel)]="editingAudit.certificate_expiry_date" />
            </div>

            <div class="form-group">
              <label>Certificate Number / Unique ID</label>
              <input type="text" name="certificate_number_unique_id"
                [(ngModel)]="editingAudit.certificate_number_unique_id" placeholder="Enter Certificate Number" />
            </div>

            <div class="form-group">
              <label>Classification</label>
              <input type="text" name="classification" [(ngModel)]="editingAudit.classification"
                placeholder="Classification" />
            </div>

            <div class="form-group">
              <label>Next Audit Due Date</label>
              <input type="date" name="next_audit_due_date" [(ngModel)]="editingAudit.next_audit_due_date" />
            </div>
          </div>
        </div>

        <!-- Assessor Information Section -->
        <div class="popup-section">
          <h3 class="section-title">Assessor Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Name of QSA</label>
              <select name="name_of_qsa" [(ngModel)]="editingAudit.name_of_qsa">
                <option [ngValue]="null">Select QSA</option>
                <!-- Store QSA ID (qsa.qsa_id) in the value -->
                <option *ngFor="let qsa of qsaList" [ngValue]="qsa.qsa_id">
                  {{ qsa.qsa_name }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>QSA License/Certificate Number</label>
              <input type="text" name="qsa_license_certificate_number"
                [(ngModel)]="editingAudit.qsa_license_certificate_number"
                placeholder="QSA License/Certificate Number" />
            </div>

            <div class="form-group">
              <label>Manager/Reviewer Name</label>
              <input type="text" name="audit_manager_reviewer_name"
                [(ngModel)]="editingAudit.audit_manager_reviewer_name" placeholder="Audit Manager Reviewer Name" />
            </div>
          </div>
        </div>

        <!-- Scope and Environment Section -->
        <div class="popup-section">
          <h3 class="section-title">Scope and Environment</h3>
          <div class="form-grid">
            <div class="form-group full-width">
              <label>Scope of Assessment</label>
              <textarea name="scope_of_assessment" [(ngModel)]="editingAudit.scope_of_assessment"
                placeholder="Scope of Assessment" rows="3"></textarea>
            </div>

            <div class="form-group full-width">
              <label>Location in Scope</label>
              <textarea name="location_of_scope" [(ngModel)]="editingAudit.location_of_scope"
                placeholder="Location in Scope" rows="3"></textarea>
            </div>
          </div>
        </div>

      </form>
    </div>

    <div class="popup-footer">
      <button class="btn-cancel" (click)="cancelEdit()"><span>Cancel</span></button>
      <button class="btn-save" (click)="saveAudit()" [disabled]="isLoading">
        <span *ngIf="!isLoading">Save Changes</span>
        <span *ngIf="isLoading">Saving...</span>
      </button>
    </div>
  </div>
</div>