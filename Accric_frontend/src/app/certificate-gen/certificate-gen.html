<div class="certificate-box">
  <div class="certificate-container" [class.expanded]="showCertificateForm">
    <!-- Certificate input form -->
    <form #certForm="ngForm" (ngSubmit)="generateCertificateFromInput()">
      <div class="input-row">
        <!-- COMPANY & ASSESSMENT SELECTION -->
        <div class="input-group" *ngIf="!manualCertificateInput">
          <!-- COMPANY -->
          <div class="search-dropdown">
            <label>Company</label>
            <input type="text" [(ngModel)]="companySearch" name="companySearch" (input)="onCompanySearch()"
              (focus)="showCompanyDropdown = true" (blur)="onCompanyBlur()" placeholder="Search company"
              autocomplete="off" required />

            <div class="search-dropdown-list" *ngIf="showCompanyDropdown && filteredCompanies.length">
              <div class="dropdown-item" *ngFor="let c of filteredCompanies" (mousedown)="selectCompany(c)">
                {{ c.legal_entity_name }}
              </div>
            </div>
          </div>

          <!-- ASSESSMENT -->
          <div class="search-dropdown">
            <label>Assessment</label>
            <input type="text" [(ngModel)]="assessmentSearch" name="assessmentSearch" [disabled]="!selectedCompanyId"
              (input)="onAssessmentSearch()" (focus)="showAssessmentDropdown = true" (blur)="onAssessmentBlur()"
              placeholder="Search assessment" autocomplete="off" required />

            <div class="search-dropdown-list" *ngIf="showAssessmentDropdown && filteredAssessments.length">
              <div class="dropdown-item" *ngFor="let a of filteredAssessments" (mousedown)="selectAssessment(a)">
                {{ a.assessment_project_name }}
              </div>
            </div>
          </div>
        </div>

        <!-- MANUAL CERTIFICATE INPUT -->
        <div class="input-group">
          <input type="text" name="certificateNo" [(ngModel)]="certificateInputValue" 
            [placeholder]="manualCertificateInput ? 'Enter certificate number manually' : 'Certificate number auto-filled'"
            [readonly]="!manualCertificateInput && selectedAssessmentId" required />

          <button class="certificate-btn" type="submit" [disabled]="loading">
            <span *ngIf="!loading">Generate</span>
            <span *ngIf="loading">Loading...</span>
          </button>
        </div>
      </div>
       <!-- CERTIFICATE FORM SECTION -->
      <div *ngIf="showCertificateForm && certificateData">
        <p class="certificate-sub-heading">Select and Edit Certificate Fields</p>
        <div class="edit-options">
          <div class="fields-container">
            <!-- Certificate No -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.certificateNo" name="certificateNoCheck" />
              <label>Certificate No</label>
              <input type="text" [(ngModel)]="certificateData.certificateNo" name="certificateNo" 
                     [disabled]="!editFields.certificateNo" />
            </div>

            <!-- Company Name -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.companyName" name="companyNameCheck" />
              <label>Company Name</label>
              <input type="text" [(ngModel)]="certificateData.companyName" name="companyName" 
                     [disabled]="!editFields.companyName" />
            </div>

            <!-- Full Address -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.full_address" name="full_address_check" />
              <label>Full Address</label>
              <input type="text" [(ngModel)]="certificateData.full_address" name="full_address" 
                     [disabled]="!editFields.full_address" (input)="splitAddress()"
                     placeholder="Street, City, State, Country, Zip" />
            </div>

            <!-- Date Issue -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.dateIssue" name="dateIssueCheck" />
              <label>Date Issue</label>
              <input class="date-input" type="date" [(ngModel)]="certificateData.dateIssue" name="dateIssue" 
                     [disabled]="!editFields.dateIssue" />
            </div>

            <!-- Date Valid -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.dateValid" name="dateValidCheck" />
              <label>Date Valid</label>
              <input class="date-input" type="date" [(ngModel)]="certificateData.dateValid" name="dateValid" 
                     [disabled]="!editFields.dateValid" />
            </div>

            <!-- Classification -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.assessment_classification"
                name="assessment_classification" />
              <label>Assessment Classification</label>
              <input type="text" [(ngModel)]="certificateData.assessment_classification"
                name="assessment_classification" [disabled]="!editFields.assessment_classification" />
            </div>

            <!-- Version -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.version" name="versionCheck" />
              <label>Version</label>
              <input type="text" [(ngModel)]="certificateData.version" name="version"
                placeholder="Standard Version 4.0.1" [disabled]="!editFields.version" />
            </div>

            <!-- Auditor Name -->
            <div class="field-row">
              <input type="checkbox" [(ngModel)]="editFields.auditor_name" name="auditorNameCheck" />
              <label>Auditor Name</label>
              <select [(ngModel)]="certificateData.auditor_name" name="auditor_name" 
                      [disabled]="!editFields.auditor_name">
                <option value="">-- Select Auditor --</option>
                <option *ngFor="let auditor of auditorList" [value]="auditor">
                  {{ auditor }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <p class="certificate-sub-heading">Certification Options</p>
        <div class="certification-options">
          <div class="options-flex-container">
            <!-- Company Name Font Size (16px-24px) -->
            <div class="option-row">
              <label>Company Font Size</label>
              <select [(ngModel)]="certificateOptions.companyNameFontSize" name="companyNameFontSize"
                (change)="onOptionsChange()">
                <option *ngFor="let size of companyNameFontSizes" [value]="size">{{size}}</option>
              </select>
            </div>

            <!-- Address Font Size (8px-16px) -->
            <div class="option-row">
              <label>Address Font Size</label>
              <select [(ngModel)]="certificateOptions.addressFontSize" name="addressFontSize"
                (change)="onOptionsChange()">
                <option *ngFor="let size of addressFontSizes" [value]="size">{{size}}</option>
              </select>
            </div>

            <!-- Version/Type Font Size (10px-16px) -->
            <div class="option-row">
              <label>Standard Font Size</label>
              <select [(ngModel)]="certificateOptions.typeFontSize" name="typeFontSize" (change)="onOptionsChange()">
                <option *ngFor="let size of typeFontSizes" [value]="size">{{size}}</option>
              </select>
            </div>

            <!-- Certificate Format -->
            <div class="option-row">
              <label>Certificate Format</label>
              <select [(ngModel)]="certificateOptions.formatType" name="formatType" (change)="onOptionsChange()">
                <option value="Softcopy">Softcopy</option>
                <option value="Printable">Printable</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="btn-certificate">
          <button class="certificate-btn" type="button" (click)="generateCertificatePdf()" [disabled]="pdfGenerating">
            <span *ngIf="!pdfGenerating">Generate Certificate</span>
            <span *ngIf="pdfGenerating">Generating PDF...</span>
          </button>
          <button class="certificate-btn btn-reset" type="button" (click)="resetForm()">
            <span>Reset Form</span>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- PDF Viewer Section -->
  <div *ngIf="showPdfViewer" #pdfViewer class="pdf-viewer-container">
    <div class="pdf-viewer-header">
      <h3>Certificate Preview</h3>
      <div class="pdf-viewer-controls">
        <button class="certificate-btn btn-download" (click)="downloadCurrentPDF()">
          <span>Download PDF</span>
        </button>
        <button class="certificate-btn btn-pdf" (click)="printPDF()">
          <span>Print PDF</span>
        </button>
        <button class="certificate-btn btn-close" (click)="closePdfViewer()">
          <span>Close</span>
        </button>
      </div>
    </div>

    <div class="pdf-viewer">
      <iframe *ngIf="pdfUrl" [src]="pdfUrl" width="100%" height="600px"
        style="border: 1px solid #ddd; border-radius: 4px;" title="Certificate PDF">
        Your browser does not support PDF viewing.
        Please <a href="javascript:void(0)" (click)="downloadCurrentPDF()">download the PDF</a> instead.
      </iframe>

      <div *ngIf="!pdfUrl" class="pdf-loading">
        <p>Loading PDF...</p>
      </div>
    </div>
  </div>
</div>