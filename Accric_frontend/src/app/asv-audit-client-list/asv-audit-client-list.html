<div class="asv-audit-list-container">
  <div class="asv-audit-list-box">
    <div class="header-row">
      <p>ASV Audit List</p>
      <div class="header-right">
        <div class="search-box">
          <img src="/assets/icons/magnifying-glass 2.png" alt="Search Icon">
          <input type="text" placeholder="Search Audits" [(ngModel)]="search_text" (input)="filter_list()">
        </div>
        <button class="export-btn" (click)="exportToExcel()"><span>Export to Excel</span></button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Company Name</th>
            <th>Project Name</th>
            <th>Number of IP</th>
            <th>Associated Organization</th>
            <th>Associated Application</th>
            <th>IP Details</th>
            <th>Status</th>
            <th>Created Date</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          <!-- In your HTML template, update the table rows like this: -->
          <tr *ngFor="let audit of filtered_list">
            <td>{{ audit.company_name || 'N/A' }}</td>
            <td>{{ audit.project_name || 'N/A' }}</td>
            <td>{{ audit.number_ip || 0 }}</td>
            <td>{{ audit.associated_organization || 'N/A' }}</td>
            <td>{{ audit.associated_application || 'N/A' }}</td>
            <td>
              <span class="ip-details" *ngIf="audit.ip_details" (click)="viewAuditDetails(audit)">
                {{ (audit.ip_details.length > 50) ? (audit.ip_details | slice:0:50) + '...' : audit.ip_details }}
              </span>
              <span *ngIf="!audit.ip_details">N/A</span>
            </td>
            <td id="audit-status">
              <span class="status-badge" [class.in-progress]="audit.status === 'IN_PROGRESS'"
                [class.completed]="audit.status === 'COMPLETED'" [class.pending]="audit.status === 'PENDING'"
                [class.failed]="audit.status === 'FAILED'">
                {{ getStatusLabel(audit.status) || 'N/A' }}
              </span>
            </td>
            <td>{{ formatDate(audit.created_at) }}</td>
            <td class="sticky-action">
              <div class="action-box">
                <img src="/assets/icons/edit.png" alt="Edit" (click)="editAudit(audit)">
                <img src="/assets/icons/delete.png" alt="Delete" (click)="deleteAudit(audit)">
                <img src="/assets/icons/view.png" alt="View Details" (click)="viewAuditDetails(audit)"
                  style="margin-left: 8px;">
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit ASV Audit Popup -->
<div class="edit-audit-popup-overlay" *ngIf="editingAudit">
  <div class="edit-audit-popup">
    <div class="popup-header">
      <h2>Edit ASV Audit</h2>
      <button class="close-btn" (click)="cancelEdit()">&times;</button>
    </div>

    <div class="popup-content">
      <form #editAuditForm="ngForm">

        <!-- Basic Information Section -->
        <div class="popup-section">
          <h3 class="section-title">Basic Information</h3>
          <div class="form-grid">

            <div class="form-group">
              <label>Company Name*</label>
              <input type="text" name="company_name" required [(ngModel)]="editingAudit.company_name"
                placeholder="Company Name" />
            </div>

            <div class="form-group">
              <label>Project Name*</label>
              <input type="text" name="project_name" required [(ngModel)]="editingAudit.project_name"
                placeholder="Project Name" />
            </div>

            <div class="form-group">
              <label>Number of IP*</label>
              <input type="number" name="number_ip" required [(ngModel)]="editingAudit.number_ip"
                placeholder="Number of IP" min="0" />
            </div>

            <div class="form-group">
              <label>Associated Organization</label>
              <input type="text" name="associated_organization" [(ngModel)]="editingAudit.associated_organization"
                placeholder="Associated Organization" />
            </div>

            <div class="form-group">
              <label>Associated Application</label>
              <input type="text" name="associated_application" [(ngModel)]="editingAudit.associated_application"
                placeholder="Associated Application" />
            </div>

            <div class="form-group full-width">
              <label>IP Details*</label>
              <textarea name="ip_details" required [(ngModel)]="editingAudit.ip_details"
                placeholder="Enter IP addresses (comma separated or one per line)" rows="3"></textarea>
              <small class="hint-text">Enter IP addresses separated by commas or new lines</small>
            </div>

          </div>
        </div>

        <!-- Audit Details Section -->
        <div class="popup-section">
          <h3 class="section-title">Audit Details</h3>
          <div class="form-grid">

            <div class="form-group">
              <label>Audit Status*</label>
              <select name="status" required [(ngModel)]="editingAudit.status">
                <option value="" disabled>Select Status</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
                <option value="FAILED">Failed</option>
              </select>
            </div>

            <div class="form-group">
              <label>Start Date</label>
              <input type="date" name="start_date" [(ngModel)]="editingAudit.start_date" />
            </div>

            <div class="form-group">
              <label>End Date</label>
              <input type="date" name="end_date" [(ngModel)]="editingAudit.end_date" />
            </div>

            <div class="form-group">
              <label>Auditor Name</label>
              <input type="text" name="auditor_name" [(ngModel)]="editingAudit.auditor_name"
                placeholder="Auditor Name" />
            </div>

            <div class="form-group">
              <label>Audit Type</label>
              <select name="audit_type" [(ngModel)]="editingAudit.audit_type">
                <option value="" disabled>Select Audit Type</option>
                <option value="PCI_ASV">PCI ASV</option>
                <option value="INTERNAL">Internal</option>
                <option value="EXTERNAL">External</option>
                <option value="VULNERABILITY">Vulnerability</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label>Findings / Notes</label>
              <textarea name="findings_notes" [(ngModel)]="editingAudit.findings_notes"
                placeholder="Enter any findings or notes" rows="3"></textarea>
            </div>

          </div>
        </div>

      </form>
    </div>

    <div class="popup-footer">
      <button class="btn-cancel" (click)="cancelEdit()"><span>Cancel</span></button>
      <button class="btn-save" (click)="saveAudit()"><span>Save Changes</span></button>
    </div>
  </div>
</div>

<!-- View IP Details Modal -->
<div class="ip-details-modal-overlay" *ngIf="viewingIpDetails">
  <div class="ip-details-modal">
    <div class="modal-header">
      <h2>IP Details - {{ selectedAudit?.project_name }}</h2>
      <button class="close-btn" (click)="closeIpDetails()">&times;</button>
    </div>

    <div class="modal-content">
      <div class="ip-list">
        <h3>Total IPs: {{ ipList.length || 0 }}</h3>
        <div class="ip-items">
          <div *ngFor="let ip of ipList" class="ip-item">
            {{ ip }}
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-close" (click)="closeIpDetails()"><span>Close</span></button>
    </div>
  </div>
</div>